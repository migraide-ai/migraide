<!doctype html>
<html lang="en">
  <!-- [Head] start -->
  <head>
    <link rel="stylesheet" href="../assets/css/plugins/style.css" />
    @@include('../layouts/head-page-meta.html', {'title': 'Customer List'}) @@include('../layouts/head-css.html')
  </head>
  <!-- [Head] end -->
  
  <!-- [Body] Start -->
  <body @@bodySetup>
    @@include('../layouts/layout-vertical.html')

    <!-- [ Main Content ] start -->
    <div class="pc-container">
      <div class="pc-content">
        <div class="card-header" style="padding-bottom: 20px;">
          <h3>Client List</h3>
        </div>
        <!-- [ Main Content ] start -->
        <div class="row">
          <!-- [ sample-page ] start -->
          <div class="col-sm-12">
            <div class="card table-card">
              <div class="card-body">
                <div class="text-end p-4 pb-sm-2">
                  <a href="/application/new-user-profile.html" class="btn btn-primary d-inline-flex align-items-center gap-2">
                    <i class="ti ti-plus f-18"></i> Add Client
                  </a>
                </div>
                <div class="table-responsive">
                  <table class="table table-hover" id="pc-dt-simple">
                    <thead>
                      <tr>
                        <th style="text-align: left;">#</th>
                        <th style="text-align: left;">Client Name</th>
                        <th style="text-align: left;">Contact</th>
                        <th style="text-align: left;">Visa Service</th>
                        <th style="text-align: left;">Status</th>
                        <th style="text-align: center;">Actions</th> <!-- Centering the Actions column -->
                      </tr>
                    </thead>
                    <tbody>
                      <!-- Clients will be dynamically populated here -->
                    </tbody>
                  </table>
                </div>                
              </div>
            </div>
          </div>
          <!-- [ sample-page ] end -->
        </div>
        <!-- [ Main Content ] end -->
      </div>
    </div>

    <!-- Client Details Modal -->
    <div class="modal fade" id="customer-modal" data-bs-keyboard="false" tabindex="-1" aria-hidden="true">
      <div class="modal-dialog modal-lg modal-dialog-centered modal-dialog-scrollable">
        <div class="modal-content">
          <div class="modal-header border-0 pb-0">
            <h5 class="mb-0">Client Details</h5>
            <a href="#" class="avtar avtar-s btn-link-danger btn-pc-default ms-auto" data-bs-dismiss="modal">
              <i class="ti ti-x f-20"></i>
            </a>
          </div>
          <div class="modal-body">
            <div class="row">
              <div class="col-lg-4">
                <div class="card">
                  <div class="card-body position-relative">
                    <div class="position-absolute end-0 top-0 p-3">
                      <span class="badge bg-primary">In Progress</span>
                    </div>
                    <div class="text-center mt-3">
                      <div class="chat-avtar d-inline-flex mx-auto">
                        <img class="rounded-circle img-fluid wid-60" src="../assets/images/user/avatar-5.jpg" alt="User image" />
                      </div>
                      <h5 class="mb-0">Faith Henry Chris</h5>
                      <p class="text-muted text-sm">Senior Data Consultant</p>
                      <hr class="my-3 border border-secondary-subtle" />
                      <div class="d-inline-flex align-items-center justify-content-between w-100 mb-3">
                        <i class="ti ti-mail"></i>
                        <p class="mb-0">faithie@gmail.com</p>
                      </div>
                      <div class="d-inline-flex align-items-center justify-content-between w-100 mb-3">
                        <i class="ti ti-phone"></i>
                        <p class="mb-0">+1 (247) 849-6968</p>
                      </div>
                      <div class="d-inline-flex align-items-center justify-content-between w-100">
                        <i class="ti ti-link"></i>
                        <a href="#" class="link-primary">
                          <p class="mb-0">https://form-url</p>
                        </a>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
              <div class="col-lg-8">
                <div class="card">
                  <div class="card-header">
                    <h5>Personal Details</h5>
                  </div>
                  <div class="card-body">
                    <ul class="list-group list-group-flush">
                      <li class="list-group-item px-0 pt-0">
                        <div class="row">
                          <div class="col-md-6">
                            <p class="mb-1 text-muted">Full Names</p>
                            <h6 class="mb-0">Faith Henry Chris</h6>
                          </div>
                        </div>
                      </li>
                      <li class="list-group-item px-0">
                        <div class="row">
                          <div class="col-md-6">
                            <p class="mb-1 text-muted">Visa Service</p>
                            <h6 class="mb-0">EB1</h6>
                          </div>
                          <div class="col-md-6">
                            <p class="mb-1 text-muted">Gender</p>
                            <h6 class="mb-0">Female</h6>
                          </div>
                        </div>
                      </li>
                      <li class="list-group-item px-0 pb-0">
                        <p class="mb-1 text-muted">Date of Birth</p>
                        <h6 class="mb-0">November 10th, 1997</h6>
                      </li>
                    </ul>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    @@include('../layouts/footer-block.html') 
    @@include('../layouts/footer-js.html')

    <!-- [Page Specific JS] start -->
    <script src="../assets/js/plugins/simple-datatables.js"></script>
    <script>
      // Setup the DataTable
      const dataTable = new simpleDatatables.DataTable('#pc-dt-simple', {
        sortable: false,
        perPage: 5
      });

      // Fetch and display clients
      document.addEventListener('DOMContentLoaded', function () {
        fetchClients();

        function fetchClients() {
          const accessToken = localStorage.getItem('accessToken');
          if (!accessToken) {
            alert('Please log in to view clients.');
            window.location.href = '../login.html';
            return;
          }

          fetch('http://127.0.0.1:5000/list_clients', {
            method: 'GET',
            headers: {
              'Authorization': `Bearer ${accessToken}`,
            },
          })
          .then(response => response.json())
          .then(clients => {
            populateClientsTable(clients);
          })
          .catch(error => {
            console.error('Error fetching clients:', error);
            alert('Failed to fetch clients.');
          });
        }

        function populateClientsTable(clients) {
          const tbody = document.querySelector('#pc-dt-simple tbody');
          tbody.innerHTML = '';  // Clear table

          clients.forEach((client, index) => {
            const row = document.createElement('tr');
            row.innerHTML = `
              <td>${index + 1}</td>
              <td>
                <div class="row">
                  <div class="col-auto">
                    <img src="../assets/images/user/avatar-${(index % 9) + 1}.jpg" alt="user-image" class="wid-40 rounded-circle" />
                  </div>
                  <div class="col">
                    <h6 class="mb-0">${client.first_name}  ${client.middle_name} ${client.last_name}</h6>
                    <p class="text-muted f-12 mb-0">${client.email_address}</p>
                  </div>
                </div>
              </td>
              <td>${client.phone_number}</td>
              <td>${client.visa_services}</td>
              <td>${getStatusBadge(client.status)}</td>
              <td class="text-center">
                <ul class="list-inline me-auto mb-0">
                  <li class="list-inline-item" title="View">
                    <a href="#" class="btn-link-secondary" onclick="viewClientDetails('${client._id}')">
                      <i class="ti ti-eye f-18"></i>
                    </a>
                  </li>
                  <li class="list-inline-item" title="Nudge">
                    <a href="#" onclick="nudgeClient('${client.email_address}')" class="btn-link-success">
                      <i class="ti ti-clock f-18" style="color: red;"></i>
                    </a>
                  </li>
                  <li class="list-inline-item" title="Delete">
                    <a href="#" onclick="deleteClient('${client._id}')" class="btn-link-danger">
                      <i class="ti ti-trash f-18"></i>
                    </a>
                  </li>
                </ul>
              </td>
            `;
            tbody.appendChild(row);
          });
        }

        function getStatusBadge(status) {
          switch (status) {
            case 'Not Started': return '<span class="badge bg-light-danger rounded-pill f-12">Not Started</span>';
            case 'In Progress': return '<span class="badge bg-light-primary rounded-pill f-12">In Progress</span>';
            case 'Completed': return '<span class="badge bg-light-success rounded-pill f-12">Completed</span>';
            default: return '<span class="badge bg-light-secondary rounded-pill f-12">Unknown</span>';
          }
        }

        // Function to view client details
            window.viewClientDetails = function(clientId) {
              const accessToken = localStorage.getItem('accessToken');
              fetch(`http://127.0.0.1:5000/client_details/${clientId}`, {
                  method: 'GET',
                  headers: {
                      'Authorization': `Bearer ${accessToken}`,
                  },
              })
              .then(response => response.json())
              .then(client => {
                  populateClientModal(client);
              })
              .catch(error => {
                  console.error('Error fetching client details:', error);
                  alert('Failed to fetch client details.');
              });
          }

          function populateClientModal(client) {
            document.getElementById('client-name').textContent = `${client.first_name} ${client.middle_name} ${client.last_name}`;
            document.getElementById('modal-client-name').textContent = `${client.first_name} ${client.middle_name} ${client.last_name}`;
            document.getElementById('client-status').textContent = client.application_status;
            document.getElementById('client-email').textContent = client.email_address;
            document.getElementById('client-phone').textContent = client.phone_number;
            document.getElementById('client-visa-service').textContent = client.visa_services;
            document.getElementById('client-gender').textContent = client.client_gender;
            document.getElementById('client-dob').textContent = client.date_of_birth;

            const modal = new bootstrap.Modal(document.getElementById('customer-modal'));
            modal.show();
          }

          window.deleteClient = function(clientId) {
              if (!confirm('Are you sure you want to delete this client?')) return;

              const accessToken = localStorage.getItem('accessToken');
              fetch(`http://127.0.0.1:5000/delete_client/${clientId}`, {
                  method: 'DELETE',
                  headers: {
                      'Authorization': `Bearer ${accessToken}`,
                  },
              })
              .then(response => response.json())
              .then(data => {
                  if (data.msg === 'Client deleted successfully') {
                      alert('Client deleted');
                      fetchClients(); // Refresh the table
                  } else {
                      alert('Failed to delete client.');
                  }
              })
              .catch(error => {
                  console.error('Error deleting client:', error);
                  alert('Failed to delete client.');
              });
          }

          window.nudgeClient = function(email) {
              const accessToken = localStorage.getItem('accessToken');
              fetch('http://127.0.0.1:5000/send_nudge', {
                  method: 'POST',
                  headers: {
                      'Authorization': `Bearer ${accessToken}`,
                      'Content-Type': 'application/json',
                  },
                  body: JSON.stringify({ email_address: email }),
              })
              .then(response => response.json())
              .then(data => {
                  if (data.msg === 'Nudge sent successfully') {
                      alert('Nudge email sent!');
                  } else {
                      alert('Failed to send nudge.');
                  }
              })
              .catch(error => {
                  console.error('Error nudging client:', error);
                  alert('Failed to send nudge.');
              });
          }
      });
  </script>
    <!-- [Page Specific JS] end -->
    
    @@include('../layouts/customizer.html')
  </body>
  <!-- [Body] end -->
</html>
