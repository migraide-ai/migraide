<!doctype html>
<html lang="en">
  <!-- [Head] start -->
  <head>
    <link rel="stylesheet" href="../assets/css/plugins/style.css" />
    @@include('../layouts/head-page-meta.html', {'title': 'Customer List'}) @@include('../layouts/head-css.html')
  </head>
  <!-- [Head] end -->
  
  <!-- [Body] Start -->
  <body @@bodySetup>
    @@include('../layouts/layout-vertical.html')

    <!-- [ Main Content ] start -->
    <div class="pc-container">
      <div class="pc-content">
        <div class="card-header" style="padding-bottom: 20px;">
          <h3>Client List</h3>
        </div>
        <!-- [ Main Content ] start -->
        <div class="row">
          <!-- [ sample-page ] start -->
          <div class="col-sm-12">
            <div class="card table-card">
              <div class="card-body">
                <div class="d-flex justify-content-between align-items-center p-4 pb-sm-2">
                  <div class="w-25">
                  </div>
                  <a href="/application/new-user-profile.html" class="btn btn-primary d-inline-flex align-items-center gap-2">
                    <i class="ti ti-plus f-18"></i> Add Client
                  </a>
                </div>
                <div class="table-responsive">
                  <table class="table table-hover" id="pc-dt-simple">
                    <thead>
                      <tr>
                        <th class="text-left">#</th>
                        <th class="text-left">Client Name</th>
                        <th class="text-left">Contact</th>
                        <th class="text-left">Visa Service</th>
                        <th class="text-left">Status</th>
                        <th class="text-center">Actions</th>
                      </tr>
                    </thead>
                    <tbody>
                      <!-- Clients will be dynamically populated here -->
                    </tbody>
                  </table>
                </div>                
              </div>
            </div>
          </div>
          <!-- [ sample-page ] end -->
        </div>
        <!-- [ Main Content ] end -->
      </div>
    </div>
<!-- Client Details Modal -->
<div class="modal fade" id="customer-modal" data-bs-keyboard="false" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-centered modal-dialog-scrollable">
    <div class="modal-content">
      <div class="modal-header border-0 pb-0">
        <h5 class="mb-0">Client Details</h5>
        <a href="#" class="avtar avtar-s btn-link-danger btn-pc-default ms-auto" data-bs-dismiss="modal">
          <i class="ti ti-x f-20"></i>
        </a>
      </div>
      <div class="modal-body">
        <div class="row">
          <div class="col-lg-4">
            <div class="card">
              <div class="card-body position-relative">
                <div class="position-absolute end-0 top-0 p-3">
                  <span class="badge bg-primary" data-field="status">In Progress</span>
                </div>
                <div class="text-center mt-3">
                  <div class="chat-avtar d-inline-flex mx-auto">
                    <img class="rounded-circle img-fluid wid-60" src="../assets/images/user/avatar-5.jpg" alt="User image" data-field="avatar"/>
                  </div>
                  <h5 class="mb-0" data-field="full-name">Faith Henry Chris</h5>
                  <p class="text-muted text-sm" data-field="occupation">Senior Data Consultant</p>
                  <hr class="my-3 border border-secondary-subtle" />
                  <div class="d-inline-flex align-items-center justify-content-between w-100 mb-3">
                    <i class="ti ti-mail"></i>
                    <p class="mb-0" data-field="email">faithie@gmail.com</p>
                  </div>
                  <div class="d-inline-flex align-items-center justify-content-between w-100 mb-3">
                    <i class="ti ti-phone"></i>
                    <p class="mb-0" data-field="phone">+1 (247) 849-6968</p>
                  </div>
                  <div class="d-inline-flex align-items-center justify-content-between w-100">
                    <i class="ti ti-link"></i>
                    <a href="#" class="link-primary" data-field="form-url">
                      <p class="mb-0">https://form-url</p>
                    </a>
                  </div>
                </div>
              </div>
            </div>
          </div>
          <div class="col-lg-8">
            <div class="card">
              <div class="card-header">
                <h5>Personal Details</h5>
              </div>
              <div class="card-body">
                <ul class="list-group list-group-flush">
                  <li class="list-group-item px-0 pt-0">
                    <div class="row">
                      <div class="col-md-6">
                        <p class="mb-1 text-muted">Full Names</p>
                        <h6 class="mb-0" data-field="full-name-details">Faith Henry Chris</h6>
                      </div>
                    </div>
                  </li>
                  <li class="list-group-item px-0">
                    <div class="row">
                      <div class="col-md-6">
                        <p class="mb-1 text-muted">Visa Service</p>
                        <h6 class="mb-0" data-field="visa-service">EB1</h6>
                      </div>
                      <div class="col-md-6">
                        <p class="mb-1 text-muted">Gender</p>
                        <h6 class="mb-0" data-field="gender">Female</h6>
                      </div>
                    </div>
                  </li>
                  <li class="list-group-item px-0 pb-0">
                    <p class="mb-1 text-muted">Date of Birth</p>
                    <h6 class="mb-0" data-field="dob">November 10th, 1997</h6>
                  </li>
                </ul>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Schedule Review Modal -->
<div class="modal fade" id="review-modal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered" style="width: 350px;">
    <div class="modal-content">
      <div class="modal-header border-0">
        <h5 class="modal-title">Schedule a Review Session</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-footer border-0">
        <button type="button" class="btn btn-primary" style="width:100%; height: 44px;" id="schedule-meet-btn">
          Schedule Google Meet
        </button>
      </div>
    </div>
  </div>
</div>

@@include('../layouts/footer-block.html') 
@@include('../layouts/footer-js.html')

<!-- [Page Specific JS] start -->
<script src="../assets/js/plugins/simple-datatables.js"></script>
<script>
  // Global variables for scheduling
  let currentClientEmail = '';
  let currentClientName = '';
  
  // Setup the DataTable
  const dataTable = new simpleDatatables.DataTable('#pc-dt-simple', {
      sortable: false,
      perPage: 5
  });
  
  document.addEventListener('DOMContentLoaded', function () {
      // Add table styles
      const tableStyle = document.createElement('style');
      tableStyle.textContent = `
          .table th {
              text-align: left !important;
              padding-left: 1rem !important;
          }
          .table td {
              text-align: left !important;
              padding-left: 1rem !important;
              vertical-align: middle;
          }
          /* Keep Actions column centered */
          .table th:last-child,
          .table td:last-child {
              text-align: center !important;
              padding-left: 0 !important;
          }
          /* Column widths */
          .table td:first-child {
              width: 5%;
          }
          .table td:nth-child(2) {
              width: 30%;
          }
          .table td:nth-child(3) {
              width: 20%;
          }
          .table td:nth-child(4) {
              width: 20%;
          }
          .table td:nth-child(5) {
              width: 15%;
          }
          .table td:last-child {
              width: 10%;
          }
          /* Fix for user avatar and name alignment */
          .table .row {
              margin-left: 0;
              margin-right: 0;
          }
          .table .col-auto {
              padding-left: 0;
          }
      `;
      document.head.appendChild(tableStyle);
  
      // Initialize search functionality
      const searchInput = document.querySelector('[type="search"]');
      if (searchInput) {
          searchInput.addEventListener('keyup', function(e) {
              if (dataTable) {
                  dataTable.search(e.target.value);
              }
          });
      }
   // Add schedule button event listener
   const scheduleMeetBtn = document.getElementById('schedule-meet-btn');
   if (scheduleMeetBtn) {
       scheduleMeetBtn.addEventListener('click', function() {
           console.log('Scheduling meet for:', currentClientName, currentClientEmail);
           scheduleGoogleMeet(currentClientEmail, currentClientName);
           const modal = bootstrap.Modal.getInstance(document.getElementById('review-modal'));
           if (modal) {
               modal.hide();
           }
       });
   }
  
      // Fetch initial data
      fetchClients();
  });
  
  function fetchClients() {
      const accessToken = localStorage.getItem('accessToken');
      if (!accessToken) {
          alert('Please log in to view clients.');
          window.location.href = '../login.html';
          return;
      }
  
      fetch('http://127.0.0.1:5000/list_clients', {
          method: 'GET',
          headers: {
              'Authorization': `Bearer ${accessToken}`,
          },
      })
      .then(response => response.json())
      .then(clients => {
          populateClientsTable(clients);
      })
      .catch(error => {
          console.error('Error fetching clients:', error);
          alert('Failed to fetch clients.');
      });
  }
  
  function populateClientsTable(clients) {
      const tbody = document.querySelector('#pc-dt-simple tbody');
      tbody.innerHTML = '';  // Clear table
  
      clients.forEach((client, index) => {
          const row = document.createElement('tr');
          row.innerHTML = `
              <td class="text-left">${index + 1}</td>
              <td class="text-left">
                  <div class="row align-items-center">
                      <div class="col-auto">
                          <img src="../assets/images/user/avatar-${(index % 9) + 1}.jpg" alt="user-image" class="wid-40 rounded-circle" />
                      </div>
                      <div class="col">
                          <h6 class="mb-0">${client.first_name} ${client.middle_name || ''} ${client.last_name}</h6>
                          <p class="text-muted f-12 mb-0">${client.email_address}</p>
                      </div>
                  </div>
              </td>
              <td class="text-left">${client.phone_number || 'N/A'}</td>
              <td class="text-left">${client.visa_services || 'N/A'}</td>
              <td class="text-left">${getStatusBadge(client.status)}</td>
              <td class="text-center">
                  <ul class="list-inline me-auto mb-0">
                      <li class="list-inline-item" title="View">
                          <a href="#" class="btn-link-secondary" onclick="viewClientDetails('${client._id}')">
                              <i class="ti ti-eye f-18"></i>
                          </a>
                      </li>
                      <li class="list-inline-item" title="Schedule Review">
                          <a href="#" class="btn-link-primary" onclick="openScheduleModal('${client.email_address}', '${client.first_name} ${client.last_name}')" data-bs-toggle="modal" data-bs-target="#review-modal">
                              <i class="ti ti-calendar f-18"></i>
                          </a>
                      </li>
                      <li class="list-inline-item" title="Nudge">
                          <a href="#" onclick="nudgeClient('${client.email_address}')" class="btn-link-success">
                              <i class="ti ti-clock f-18" style="color: red;"></i>
                          </a>
                      </li>
                      <li class="list-inline-item" title="Delete">
                          <a href="#" onclick="deleteClient('${client._id}')" class="btn-link-danger">
                              <i class="ti ti-trash f-18"></i>
                          </a>
                      </li>
                  </ul>
              </td>
          `;
          tbody.appendChild(row);
      });
  }
  function getStatusBadge(status) {
    switch (status) {
        case 'Not Started': return '<span class="badge bg-light-danger rounded-pill f-12">Not Started</span>';
        case 'In Progress': return '<span class="badge bg-light-primary rounded-pill f-12">In Progress</span>';
        case 'Completed': return '<span class="badge bg-light-success rounded-pill f-12">Completed</span>';
        default: return '<span class="badge bg-light-secondary rounded-pill f-12">Unknown</span>';
    }
}

// Helper function for status badge classes
function getStatusClass(status) {
    switch (status) {
        case 'In Progress': return 'bg-primary';
        case 'Completed': return 'bg-success';
        case 'Not Started': return 'bg-danger';
        default: return 'bg-secondary';
    }
}

window.openScheduleModal = function(email, name) {
    currentClientEmail = email;
    currentClientName = name;
}

window.scheduleGoogleMeet = async function(clientEmail, clientName) {
  try {
      const businessData = JSON.parse(localStorage.getItem('businessData'));
      if (!businessData || !businessData.email) {
          throw new Error('User email not found');
      }

      const userEmail = businessData.email;

      // Set meeting time for tomorrow at 2 PM UTC
      const tomorrow = new Date();
      tomorrow.setDate(tomorrow.getDate() + 1);
      tomorrow.setUTCHours(14, 0, 0, 0);
      
      // Set meeting end time (1 hour later)
      const endTime = new Date(tomorrow);
      endTime.setHours(tomorrow.getHours() + 1);

      // Format dates for Google Calendar URL
      const startDate = tomorrow.toISOString().replace(/[-:]/g, '').replace(/\.\d{3}/, '');
      const endDate = endTime.toISOString().replace(/[-:]/g, '').replace(/\.\d{3}/, '');

      // Create Google Calendar URL with meeting details
      const url = "https://calendar.google.com/calendar/render?action=TEMPLATE" +
          "&text=" + encodeURIComponent(`Visa Forms Review - ${clientName}`) +
          "&details=" + encodeURIComponent("Review session for your completed visa forms.") +
          "&add=" + encodeURIComponent(`${userEmail},${clientEmail}`) +
          "&location=" + encodeURIComponent("https://meet.google.com/") +
          "&dates=" + startDate + "/" + endDate;

      window.open(url, '_blank');
  } catch (error) {
      console.error('Error scheduling meeting:', error);
      alert('Failed to schedule meeting. Please make sure you are logged in.');
  }
};

// Also update the openScheduleModal function
window.openScheduleModal = function(email, name) {
  currentClientEmail = email;
  currentClientName = name;
  // Add this console.log to verify the values are being set
  console.log('Schedule modal opened for:', name, email);
};

window.viewClientDetails = function(clientId) {
    const accessToken = localStorage.getItem('accessToken');
    fetch(`http://127.0.0.1:5000/client_details/${clientId}`, {
        method: 'GET',
        headers: {
            'Authorization': `Bearer ${accessToken}`,
        },
    })
    .then(response => response.json())
    .then(client => {
        // Update modal fields with null checks
        const modalElements = {
            'h5.mb-0': `${client.first_name || ''} ${client.middle_name || ''} ${client.last_name || ''}`,
            'p.text-muted.text-sm': client.occupation || 'N/A',
            'span.badge': client.status || 'Unknown',
            '[data-field="email"]': client.email_address || 'N/A',
            '[data-field="phone"]': client.phone_number || 'N/A',
            '[data-field="form-url"]': client.form_url || '#',
            '[data-field="full-name"]': `${client.first_name || ''} ${client.middle_name || ''} ${client.last_name || ''}`,
            '[data-field="full-name-details"]': `${client.first_name || ''} ${client.middle_name || ''} ${client.last_name || ''}`,
            '[data-field="visa-service"]': client.visa_services || 'N/A',
            '[data-field="gender"]': client.client_gender || 'N/A',
            '[data-field="dob"]': client.date_of_birth || 'N/A'
        };

        // Update each element in the modal
        Object.entries(modalElements).forEach(([selector, value]) => {
            const element = document.querySelector(`#customer-modal ${selector}`);
            if (element) {
                if (selector === 'span.badge') {
                    element.className = `badge ${getStatusClass(value)}`;
                }
                element.textContent = value;
            }
        });

        // Show the modal
        const modal = new bootstrap.Modal(document.getElementById('customer-modal'));
        modal.show();
    })
    .catch(error => {
        console.error('Error fetching client details:', error);
        alert('Failed to fetch client details.');
    });
};

window.deleteClient = function(clientId) {
    if (!confirm('Are you sure you want to delete this client?')) return;

    const accessToken = localStorage.getItem('accessToken');
    fetch(`http://127.0.0.1:5000/delete_client/${clientId}`, {
        method: 'DELETE',
        headers: {
            'Authorization': `Bearer ${accessToken}`,
        },
    })
    .then(response => response.json())
    .then(data => {
        if (data.msg === 'Client deleted successfully') {
            alert('Client deleted');
            fetchClients(); // Refresh the table
        } else {
            alert('Failed to delete client.');
        }
    })
    .catch(error => {
        console.error('Error deleting client:', error);
        alert('Failed to delete client.');
    });
};

window.nudgeClient = async function(email) {
    const accessToken = localStorage.getItem('accessToken');
    try {
        // Send nudge
        const nudgeResponse = await fetch('http://127.0.0.1:5000/send_nudge', {
            method: 'POST',
            headers: {
                'Authorization': `Bearer ${accessToken}`,
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ email_address: email,
            form_url: "https://forms.com/test" }),
        });

        const nudgeData = await nudgeResponse.json();
        
        if (nudgeData.msg === 'Nudge sent successfully') {
            // Update the client's status after successful nudge
            const updateResponse = await fetch('http://127.0.0.1:5000/update_status_by_email', {
                method: 'POST',
                headers: {
                    'Authorization': `Bearer ${accessToken}`,
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    email_address: email,
                    status: 'In Progress'
                }),
            });
            const updateData = await updateResponse.json();

            if (updateData.msg === 'Application status updated successfully') {
                alert('Nudge sent and status updated successfully!');
                fetchClients(); // Refresh the client list
            } else {
                alert(updateData.msg || 'Status update failed');
            }
        } else {
            alert(nudgeData.msg || 'Failed to send nudge');
        }
    } catch (error) {
        console.error('Error:', error);
        alert('Failed to process request. Please try again.');
    }
};
</script>

<!-- [Page Specific JS] end -->
@@include('../layouts/customizer.html')
</body>
<!-- [Body] end -->
</html>