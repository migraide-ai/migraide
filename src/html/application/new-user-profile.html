<!doctype html>
<html lang="en">
 <!-- [Head] start -->
 <head>
   <link rel="stylesheet" href="../assets/css/plugins/datepicker-bs5.min.css" />
   <script src="https://cdn.jsdelivr.net/npm/choices.js/public/assets/scripts/choices.min.js"></script>
   <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/choices.js/public/assets/styles/choices.min.css">
   @@include('../layouts/head-page-meta.html', {'title': 'Add Product'}) @@include('../layouts/head-css.html')
  
   <style>
     .alert-message {
       position: fixed;
       top: 80px;
       right: 20px;
       background-color: #28a745;
       color: white;
       padding: 10px 20px;
       border-radius: 25px;
       display: none;
       z-index: 1000;
       display: flex;
       align-items: center;
       gap: 10px;
       box-shadow: 0px 4px 6px rgba(0, 0, 0, 0.1);
     }
     .alert-message .icon {
       width: 24px;
       height: 24px;
       background-color: white;
       color: #28a745;
       border-radius: 50%;
       display: flex;
       align-items: center;
       justify-content: center;
       font-weight: bold;
     }
     .check-icon {
       width: 24px;
       height: 24px;
       background: white;
       border-radius: 50%;
       display: flex;
       align-items: center;
       justify-content: center;
     }
     .check-icon::before {
       content: '\2713';
       color: #28a745;
       font-size: 18px;
       font-weight: bold;
     }
   </style>
 </head>
 <!-- [Head] end -->
 <!-- [Body] Start -->
 <body @@bodySetup>
   @@include('../layouts/layout-vertical.html')
   <!-- [ Main Content ] start -->
   <div class="pc-container">
     <div class="pc-content">
       <div class="card-header" style="padding-bottom: 20px; position: relative; display: flex; justify-content: space-between; align-items: center;">
         <h3>Client Profile Setup</h3>
       </div>
       <!-- Progress bar placed at the top of both pages -->
       <div class="card" id="additional-information-section" style="border-radius: 8px; border: 1px solid #DDDDDD; padding-top: 0px; ">
         <!-- Title Section with Underline for "Form controls" -->
         <div class="card-header" style="padding-bottom: 10px; border-bottom: 1px solid #E0E0E0; width: 100%;">
           <h5 style="font-family: 'Inter', sans-serif; font-size: 16px; font-weight: 600; color: #333;  padding-right: 30px;">
             Add a client to initialize their visa form filling session.            </h5>
         </div>         
       <!-- [ Main Content ] start -->
       <div class="row">
         <!-- [ sample-page ] start -->
         <div class="col-sm-12">
             <div class="card-body">
               <form id="clientForm">
                 <div class="row">
                   <div class="col-md-12" style="display: flex; gap: 20px;">
                     <div class="mb-3" style="width: 33%;">
                       <label class="form-label">First Name</label>
                       <input type="text" class="form-control" id="first_name" placeholder="Enter First Name" pattern="[A-Za-z]+" title="Only letters are allowed" required />
                     </div>
                     <div class="mb-3" style="width: 33%;">
                       <label class="form-label">Middle Name(s)</label>
                       <input type="text" class="form-control" id="middle_name" placeholder="Enter Middle Name" pattern="[A-Za-z]+" title="Only letters are allowed" required />
                     </div>
                     <div class="mb-3" style="width: 33%;">
                       <label class="form-label">Last Name</label>
                       <input type="text" class="form-control" id="last_name" placeholder="Enter Last Name" pattern="[A-Za-z]+" title="Only letters are allowed" required />
                     </div>
                   </div>
               </div>
               <div class="row">
                 <div class="col-md-12" style="display: flex; gap: 20px;">
                   <div class="mb-3" style="width: 33%;">
                     <label class="form-label">Email Address</label>
                     <input type="email" class="form-control" id="email" placeholder="Enter Client's Email" required />
                   </div>
                   <div class="mb-3" style="width:33%">
                     <label class="form-label">Client Phone Number</label>
                     <input type="tel" class="form-control" id="phone" placeholder="Enter Client's Phone" pattern="[0-9]{10,15}" title="Only numbers are allowed, between 10 to 15 digits" required />
                   </div>
                   <div class="mb-3" style="width:33%">
                       <label class="form-label">Date of Birth</label>
                       <div>
                       <input type="date" class="form-control" id="dob" placeholder="Enter Client DOB" required />
                       </div>
                     </div>
                 </div>
                   <div class="col-md-12" style="display: flex; gap: 20px;">
                     <div class="mb-3" style="width: 33%;">
                       <label class="form-label">Client's Profession</label>
                       <input type="text" class="form-control" id="profession" placeholder="Enter Client's Profession" pattern="[A-Za-z ]+" title="Only letters and spaces are allowed" required />
                     </div>
                     <div class="mb-3" style="width:33%">
                       <label class="form-label">Visa Services</label>
                       <select class="form-select" id="visa_service" required>
                         <option value="">Select a service</option>
                         <option>EB1</option>
                         <option>EB2</option>
                         <option>EB1 & EB2</option>
                       </select>
                     </div>
                     <div class="mb-3" style="width:33%">
                       <label class="form-label">Client Gender</label>
                       <select class="form-select" id="gender" required>
                         <option value="">Select gender</option>
                         <option>Male</option>
                         <option>Female</option>
                       </select>
                     </div>
                   </div>
             </div>
                 <div class="text-end btn-page mt-4">
                   <button class="btn btn-outline-secondary" id="cancelButton" type="button">Cancel</button>
                   <button id="initializeButton" class="btn btn-primary" type="button" style="width: 287px; height: 44px;">Initialize Form Filling</button>
                 </div>
               </form>
             </div>
         </div>
         <!-- [ sample-page ] end -->
       </div>
       <!-- [ Main Content ] end -->
     </div>
   </div>
   <!-- [ Main Content ] end -->
   @@include('../layouts/footer-block.html') @@include('../layouts/footer-js.html') @@include('../layouts/customizer.html')
   <script src="../assets/js/plugins/datepicker-full.min.js"></script>
   <script>
    document.addEventListener('DOMContentLoaded', function() {
      document.getElementById('initializeButton').addEventListener('click', function() {
        const formFields = ['first_name', 'middle_name', 'last_name', 'email', 'phone', 'dob', 'profession', 'visa_service', 'gender'];
        let valid = true;
  
        formFields.forEach(function(fieldId) {
          const field = document.getElementById(fieldId);
          if (!field.checkValidity()) {
            valid = false;
            field.reportValidity();
          }
        });
  
        if (valid) {
          submitForm();
        }
      });

      function submitForm() {
        const formData = {
          first_name: document.getElementById('first_name').value,
          middle_name: document.getElementById('middle_name').value,
          last_name: document.getElementById('last_name').value,
          email_address: document.getElementById('email').value,
          phone_number: document.getElementById('phone').value,
          date_of_birth: document.getElementById('dob').value,
          clients_profession: document.getElementById('profession').value,
          visa_services: document.getElementById('visa_service').value,
          client_gender: document.getElementById('gender').value
        };
  
        const accessToken = localStorage.getItem('accessToken');
  
        if (!accessToken) {
          alert('Please log in to continue.');
          window.location.href = '../login.html';
          return;
        }
  
        fetch('http://127.0.0.1:5001/api/dashboard/add_client', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${accessToken}`
          },
          body: JSON.stringify(formData)
        })
        .then(response => {
          if (response.status === 401) {
            throw new Error("Session expired or not found. Please log in again.");
          }
          return response.json();
        })
        .then(data => {
          if (data.msg === 'Client added successfully') {
            showAlert('Client added successfully');
            sendNudge(formData.email_address);  // Call sendNudge after successful client addition
          } else {
            alert('Error: ' + data.msg);
          }
        })
        .catch(error => {
          if (error.message.includes("Session expired")) {
            alert(error.message);
            window.location.href = '../pages/login.html';
          } else {
            alert('An error occurred: ' + error.message);
          }
        });
      }

      function sendNudge(emailAddress) {
        const accessToken = localStorage.getItem('accessToken');
        if (!accessToken) {
          alert('Please log in to continue.');
          window.location.href = '../login.html';
          return;
        }

        fetch('http://127.0.0.1:5001/api/dashboard/send_nudge', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${accessToken}`
          },
          body: JSON.stringify({ email_address: emailAddress })
        })
        .then(response => {
          if (response.status === 401) {
            throw new Error("Session expired or not found. Please log in again.");
          }
          return response.json();
        })
        .then(data => {
          if (data.msg === 'Nudge sent successfully') {
            showAlert('Client added successfully');
            redirectAfterSuccess();
          } else {
            alert('Error: ' + data.msg);
          }
        })
        .catch(error => {
          if (error.message.includes("Session expired")) {
            alert(error.message);
            window.location.href = '../pages/login.html';
          } else {
            alert('An error occurred: ' + error.message);
          }
        });
      }

      function showAlert(message) {
        let alertMessage = document.querySelector('.alert-message');
        if (!alertMessage) {
          alertMessage = document.createElement('div');
          alertMessage.className = 'alert-message';
          alertMessage.innerHTML = `<span class="check-icon"></span> Client added successfully`;
          document.body.appendChild(alertMessage);
        } else {
          alertMessage.innerHTML = `<span class="check-icon"></span> Client added successfully`;
        }
        alertMessage.style.display = 'flex';
        setTimeout(function () {
          alertMessage.style.display = 'none';
        }, 1000);
      }

      function redirectAfterSuccess() {
        setTimeout(function () {
          window.location.href = '/application/client-list.html'; // Redirect after success
        }, 2000);
      }
    });
  </script>
</body>
</html>